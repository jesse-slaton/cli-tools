name: Release Path Commander

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.1.0)'
        required: true
        type: string

jobs:
  build-windows:
    name: Build Windows Release
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: path-commander

      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_no_v=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Build release binary
        working-directory: path-commander
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Prepare release assets
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version_no_v }}"
          ARCHIVE_NAME="path-commander-${VERSION}-windows-x64"

          mkdir -p release/${ARCHIVE_NAME}

          # Copy binary
          cp path-commander/target/x86_64-pc-windows-msvc/release/pc.exe release/${ARCHIVE_NAME}/

          # Copy README if exists
          if [ -f path-commander/README.md ]; then
            cp path-commander/README.md release/${ARCHIVE_NAME}/
          fi

          # Copy LICENSE if it exists
          if [ -f path-commander/LICENSE ]; then
            cp path-commander/LICENSE release/${ARCHIVE_NAME}/
          elif [ -f LICENSE ]; then
            cp LICENSE release/${ARCHIVE_NAME}/
          else
            echo "This software is provided as-is." > release/${ARCHIVE_NAME}/LICENSE.txt
          fi

          # Create archive
          cd release
          7z a -tzip "${ARCHIVE_NAME}.zip" "${ARCHIVE_NAME}"/*

          # Generate SHA256 checksum
          sha256sum "${ARCHIVE_NAME}.zip" > "${ARCHIVE_NAME}.zip.sha256"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: path-commander-windows-x64
          path: |
            release/*.zip
            release/*.sha256
          retention-days: 5

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Path Commander ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release/*.zip
            release/*.sha256
          body: |
            ## Path Commander ${{ steps.version.outputs.version }}

            Windows PATH environment variable manager with TUI interface.

            ### Installation
            1. Download `path-commander-${{ steps.version.outputs.version_no_v }}-windows-x64.zip`
            2. Extract to a directory in your PATH
            3. Run `pc.exe`

            ### Verification
            Verify the download with SHA256:
            ```
            certutil -hashfile path-commander-${{ steps.version.outputs.version_no_v }}-windows-x64.zip SHA256
            ```

            ### Features
            - Visual TUI for managing PATH variables
            - Support for both USER and MACHINE paths
            - Dead path detection and cleanup
            - Duplicate path detection
            - Path normalization
            - Backup and restore functionality
            - Full mouse support
            - Directory creation for non-existent paths

            ### Requirements
            - Windows 10 or later
            - Administrator privileges for MACHINE path modifications
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
